<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8">
  <title>ØµÙØ­Ø© ØªØ¬Ù‡ÙŠØ² Ø§Ù„Ø·Ù„Ø¨Ø§Øª</title>
  <style>
    body { direction: rtl; font-family: Arial; background-color: #f9f9f9; padding: 20px; }
    .order-box { background: white; border-radius: 12px; padding: 20px; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
    .order-header { font-weight: bold; margin-bottom: 10px; }
    .order-item { padding: 8px 0; border-bottom: 1px solid #eee; }
    .order-item:last-child { border-bottom: none; }
    .order-actions { margin-top: 15px; }
    .order-actions button { background: #007bff; color: white; border: none; padding: 8px 14px; border-radius: 8px; cursor: pointer; margin-left: 10px; }
    .order-actions button.delete { background: red; }
    input[type='number'] { width: 50px; text-align: center; padding: 5px; border-radius: 6px; border: 1px solid #ccc; }
    pre { background: #eee; padding: 10px; border-radius: 8px; margin-top: 20px; font-size: 13px; direction: ltr; text-align: left; overflow-x: auto; }
  </style>
</head>
<body>
  <h2>ğŸ“¦ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„ÙˆØ§Ø±Ø¯Ø©</h2>
  <div id="ordersContainer">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>
  <div id="debugData"></div>

  <script>
    function renderOrders(data) {
      document.getElementById("debugData").innerHTML = '<h3>ğŸ“‹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù‚Ø§Ø¯Ù…Ø©:</h3><pre>' + JSON.stringify(data, null, 2) + '</pre>';

      const container = document.getElementById("ordersContainer");
      container.innerHTML = "";

      if (!data || data.length === 0) {
        container.innerHTML = "<p>ğŸš« Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ Ø§Ù„Ø¬Ø¯ÙˆÙ„.</p>";
        return;
      }

      const grouped = {};
      let hasValidRows = false;

      data.forEach((row, idx) => {
        const total = row[0];
        const qty = row[1];
        const price = row[2];
        const brand = row[3];
        const name = row[4];
        const code = row[5];
        const customer = row[6];
        const date = row[7];

        if (!customer || !code || !name || !qty || !price) return;

        const key = customer + " - " + date;

        if (!grouped[key]) grouped[key] = [];
        grouped[key].push({ code, name, brand, price, qty });
        hasValidRows = true;
      });

      if (!hasValidRows) {
        container.innerHTML = "<p>ğŸš« Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ ØµÙÙˆÙ ØµØ§Ù„Ø­Ø© Ù„Ù„Ø¹Ø±Ø¶.</p>";
        return;
      }

      Object.keys(grouped).forEach(orderKey => {
        const orderDiv = document.createElement("div");
        orderDiv.className = "order-box";

        const [customer, date] = orderKey.split(" - ");
        orderDiv.innerHTML = `<div class='order-header'>ğŸ‘¤ ${customer} | ğŸ—“ï¸ ${date}</div>`;

        grouped[orderKey].forEach((item, index) => {
          const itemDiv = document.createElement("div");
          itemDiv.className = "order-item";
          itemDiv.innerHTML = `
            <strong>${item.name}</strong> - ${item.brand} - Ø§Ù„ÙƒÙˆØ¯: ${item.code}<br>
            Ø§Ù„ÙƒÙ…ÙŠØ©: <input type='number' value='${item.qty}' onchange='updateQty("${orderKey}", ${index}, this.value)'> Ã— â‚ª${item.price} = â‚ª${(item.price * item.qty).toFixed(2)}
          `;
          orderDiv.appendChild(itemDiv);
        });

        const actions = document.createElement("div");
        actions.className = "order-actions";
        actions.innerHTML = `
          <button onclick='markPrepared("${orderKey}")'>âœ… ØªÙ… Ø§Ù„ØªØ¬Ù‡ÙŠØ²</button>
          <button class='delete' onclick='deleteOrder("${orderKey}")'>ğŸ—‘ï¸ Ø­Ø°Ù</button>
        `;
        orderDiv.appendChild(actions);
        container.appendChild(orderDiv);
      });
    }

    function updateQty(orderKey, itemIndex, newQty) {
      alert(`ØªÙ… ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„ÙƒÙ…ÙŠØ© Ù„Ù„Ø·Ù„Ø¨: ${orderKey}, Ø§Ù„Ø¹Ù†ØµØ± Ø±Ù‚Ù… ${itemIndex} Ø¥Ù„Ù‰ ${newQty}`);
    }

    function markPrepared(orderKey) {
      alert(`âœ… ØªÙ… ØªØ¬Ù‡ÙŠØ² Ø§Ù„Ø·Ù„Ø¨: ${orderKey}`);
    }

    function deleteOrder(orderKey) {
      if (confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø·Ù„Ø¨ØŸ")) {
        alert(`ğŸ—‘ï¸ ØªÙ… Ø­Ø°Ù Ø§Ù„Ø·Ù„Ø¨: ${orderKey}`);
      }
    }

    google.script.run.withSuccessHandler(function(data) {
      renderOrders(data);
    }).getAllOrders();
  </script>
</body>
</html>
